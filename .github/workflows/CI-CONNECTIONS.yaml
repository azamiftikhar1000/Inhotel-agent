name: Deploy Connections API

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/CI-CONNECTIONS.yaml
      - "api/**"
      - "cache/**"
      - "entities/**"
      - "unified/**"
      - Cargo.lock
      - Dockerfile.common
      - api/Dockerfile

env:
  docker_image_tag: ${{ github.sha }}
  IMAGE_NAME: gcr.io/inhotel-prod/artifacts/docker/inhotel-prod/inhotel-agent-connections
  CLUSTER_NAME: inhotel-agent
  CLUSTER_LOCATION: europe-west6

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v3

      # 1. Authenticate to Google Cloud
      - id: auth
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      # 2. Setup gcloud
      - uses: google-github-actions/setup-gcloud@v1

      # 3. Login to GCR
      - name: Login to GCR
        uses: docker/login-action@v2
        with:
          registry: gcr.io
          username: oauth2accesstoken
          password: ${{ steps.auth.outputs.access_token }}

      # 4. Build and Push
      - name: Build and Push Docker Image
        run: |
          docker build \
            --build-arg EXECUTABLE=api \
            -f api/Dockerfile \
            -t ${{ env.IMAGE_NAME }}:${{ env.docker_image_tag }} \
            .
          docker push ${{ env.IMAGE_NAME }}:${{ env.docker_image_tag }}

      # Get GKE Credentials
      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          location: ${{ env.CLUSTER_LOCATION }}

      # Deploy Secrets
      - name: Deploy Secrets to GKE
        run: |
          kubectl create secret generic app-secrets \
            --namespace=inhotel-agent-app \
            --from-literal=MONGO_URI='${{ secrets.MONGO_URI }}' \
            --from-literal=CONTEXT_DATABASE_URL='${{ secrets.CONTEXT_DATABASE_URL }}' \
            --from-literal=CONTROL_DATABASE_URL='${{ secrets.CONTROL_DATABASE_URL }}' \
            --from-literal=EVENT_DATABASE_URL='${{ secrets.EVENT_DATABASE_URL }}' \
            --from-literal=MONGO_PASSWORD='${{ secrets.MONGO_PASSWORD }}' \
            --from-literal=MONGO_INITDB_ROOT_USERNAME='${{ secrets.MONGO_INITDB_ROOT_USERNAME }}' \
            --from-literal=GCP_PROJECT_ID='${{ secrets.GCP_PROJECT_ID }}' \
            --from-literal=GCP_LOCATION_ID='${{ secrets.GCP_LOCATION_ID }}' \
            --from-literal=KMS_KEY_RING_ID='${{ secrets.KMS_KEY_RING_ID }}' \
            --from-literal=KMS_KEY_ID='${{ secrets.KMS_KEY_ID }}' \
            --from-literal=IOS_CRYPTO_SECRET='${{ secrets.IOS_CRYPTO_SECRET }}' \
            --from-literal=GATEWAY_SECRET='${{ secrets.GATEWAY_SECRET }}' \
            --from-literal=JWT_SECRET='${{ secrets.JWT_SECRET }}' \
            --from-literal=EVENT_ACCESS_PASSWORD='${{ secrets.EVENT_ACCESS_PASSWORD }}' \
            --from-literal=ENGINEERING_ACCOUNT_BUILDABLE_ID='${{ secrets.ENGINEERING_ACCOUNT_BUILDABLE_ID }}' \
            --from-literal=BUILDABLE_SECRET='${{ secrets.BUILDABLE_SECRET }}' \
            --from-literal=CORE_USER_SECRET='${{ secrets.CORE_USER_SECRET }}' \
            --from-literal=DEFAULT_LIVE_ACCESS_KEY='${{ secrets.DEFAULT_LIVE_ACCESS_KEY }}' \
            --from-literal=DEFAULT_TEST_ACCESS_KEY='${{ secrets.DEFAULT_TEST_ACCESS_KEY }}' \
            --from-literal=DEVELOPER_ACCOUNT_ACCESS_KEY='${{ secrets.DEVELOPER_ACCOUNT_ACCESS_KEY }}' \
            --from-literal=DEVELOPER_ACCOUNT_ID='${{ secrets.DEVELOPER_ACCOUNT_ID }}' \
            --from-literal=QA_ACCOUNT_BUILDABLE_ID='${{ secrets.QA_ACCOUNT_BUILDABLE_ID }}' \
            --from-literal=QA_ACCOUNT_EVENT_ACCESS_KEY='${{ secrets.QA_ACCOUNT_EVENT_ACCESS_KEY }}' \
            --from-literal=DEMO_ACCOUNT_EVENT_ACCESS_KEY='${{ secrets.DEMO_ACCOUNT_EVENT_ACCESS_KEY }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      # Deploy GCP Credentials (gcloud-config)
      - name: Deploy GCP Credentials to GKE
        run: |
          kubectl create secret generic gcloud-config \
            --namespace=inhotel-agent-app \
            --from-literal=application_default_credentials.json='${{ secrets.GCP_CREDENTIALS_JSON }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      # Deploy
      - name: Deploy to GKE
        run: |
          # Install kustomize
          curl -sfL https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.3.0/kustomize_v5.3.0_linux_amd64.tar.gz | tar -xzf -
          chmod u+x kustomize
          mv kustomize /usr/local/bin/

          # Update image tag and namespace
          cd k8s
          kustomize edit set namespace inhotel-agent-app
          kustomize edit set image gcr.io/inhotel-prod/artifacts/docker/inhotel-prod/inhotel-agent-connections=${{ env.IMAGE_NAME }}:${{ env.docker_image_tag }}
          cd ..

          # Apply changes
          kubectl apply -k k8s/
          kubectl rollout status deployment/connections-api
